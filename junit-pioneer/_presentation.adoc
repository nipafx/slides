= To Jupiter And Beyond
:backend: revealjs
:revealjs_theme: nipa-night
:revealjsdir: ../_reveal.js
:revealjs_controls: false
:revealjs_progress: false
:revealjs_slideNumber: false
:revealjs_history: true
:revealjs_center: true
:revealjs_transition: fade
:revealjs_backgroundTransition: fade
:revealjs_parallaxBackgroundImage: images/helmet.jpg
:revealjs_parallaxBackgroundSize: 6000px 4000px
:docinfo: shared
:docinfodir: ../_shared

:imagedir: images

include::../_shared/highlight.js.adoc[]

++++
<style>
.reveal .title h2 {
	font-size: 1.75em;
}
</style>
<h2>On An Exploratory Mission With JUnit Pioneer</h2>
++++

:host-name: Global Summit for Java Devs
:host-url: https://java.geekle.us/
:host-logo-url: images/logo-java-summit-2021.png
// :host-logo-style: background-color: #FFF; border-color: #FFF;
:host-twitter-name: @GeekleOfficial
:host-twitter-url: https://twitter.com/GeekleOfficial
include::../_shared/event-on-title-and-footer.adoc[]

// ######### //
// I N T R O //
// ######### //

// â‡


== JUnit Pioneer

JUnit Pioneer -- https://junit-pioneer.org[junit-pioneer.org]:

* provides extensions for https://github.com/junit-team/junit5/[JUnit 5] and its https://junit.org/junit5/docs/current/user-guide/[Jupiter API]
* small project (5k lines of code, 4 maintainers)

Why is it interesting?

* JUnit 5 is thrilling
* grew a (small) community on Twitch
* neat build and Git practices
* one-click releases
* automatic website build

=== Lots to talk about!

* JUnit 5 and its extension model
* Pioneer's extensions
* Pioneer's mission statement and history
* how live-streaming on Twitch grew a community
* organizational style and contribution guide
* code style, Git practices, release considerations
* how we use Shipkit and GitHub actions for one-click releases
* building the website with Jekyll and GitHub actions

== JUnit Extensions

Crash course to JUnit 5 and +
its extension model.

(This is _very_ incomplete!)

=== JUnit 5

A simple test:

```java
class JUnit5Test {

	@Test
	void test() {
		assertTrue(true);
	}

}
```

* need an API to write tests against
* need an engine that executes them

=== Separation Of Concerns

Separation of concerns in JUnit 5:

. an API to write tests against
. an API to discover and run tests
[loweralpha]
.. specific engine per variant of tests +
(e.g. JUnit 4 or JUnit 5)
.. orchestration of engines
.. API between them

=== Architecture

image::images/architecture-limited-lean.png[style="diagram", width=550]

=== JUnit Jupiter

* defines test API
* defines extension API
* contains engine for them

Often referred to as "JUnit 5".

=== Extension Model

Jupiter allows seamless extensions:

```java
@Test
@DisabledOnFriday
void failingTest() {
	assertTrue(false);
}
```

Cornerstones:

* extensions interact with _extension points_
* extensions must be registered +
  (possibly with annotations)

=== Extension Points

An incomplete list:

* instance post processor
* `@BeforeAll` and `@BeforeEach`
* execution condition
* exception handling
* `@AfterEach` and `@AfterAll`

Each represented by an interface, +
e.g. `ExecutionCondition`.

=== Extension Example

How to disable tests on Friday:

```java
public class DisabledOnFridayCondition
		implements ExecutionCondition {

	@Override
	public ConditionEvaluationResult evaluate(/**/) {
		if (isFriday())
			return ConditionEvaluationResult
				.disabled("Weekend! ğŸ•ºğŸ¾ğŸ’ƒğŸ¼");
		else
			return ConditionEvaluationResult
				.enabled("Run the test ğŸ˜¬");
	}

}
```

=== Registering Annotations

Jupiter is aware of https://en.wikibooks.org/wiki/Java_Programming/Annotations/Meta-Annotations[meta annotations]. +
â‡ We can create our own annotations!

```java
// [... more annotations ...]
@ExtendWith(DisabledOnFridayCondition.class)
public @interface DisabledOnFriday { }

@Test
@DisabledOnFriday
void failingTest() {
	assertTrue(false);
}
```


== Pioneer Extensions

An incomplete list:

* Cartesian products for parameters
* set default locale
* set system properties
* publish issue information
* retry failed tests

Let's see some incomplete examples!

=== Cartesian Product

```java
@CartesianProductTest
@CartesianValueSource(ints = { 1, 2 })
@CartesianValueSource(strings = { "A", "B" })
void test(int number, String character) {
    // called four times - with:
	// (1, "A") (1, "B") (2, "A") (2, "B")
}
```

=== Default Locale

```java
@Test
@DefaultLocale(language = "en")
void test() {
    assertThat(Locale.getDefault())
        .isEqualTo(new Locale("en"));
}
```

=== System Properties

```java
@Test
@ClearSystemProperty(key = "user.name")
@SetSystemProperty(key = "user.dir", value = "...")
void test() {
    assertThat(System.getProperty("user.name"))
		.isNull();
    assertThat(System.getProperty("user.dir"))
		.isEqualTo("...");
}
```

=== Issue Information

Mark tests that belong to issues:

```java
@Test
@Issue("REQ-123")
void test() {
    // a test for the issue "REQ-123"
}
```

Process information after execution:

// https://yuml.me/nipafx/edit/junit-pioneer-issue-test-suite
image::images/issue-test-suite.png[role="diagram"]

=== Retrying Tests

```java
@RetryingTest(3)
void test() {
    // if 1st, 2nd, or 3rd execution passes,
	// the test passes; otherwise fails
}
```

=== Others

We have a few more:

* ranges for parameters
* set default time zone
* set environment variables
* disable specific parameterized tests
* publish report entries
* mocking standard I/O

Isn't this all a bit random?

â‡ Yes!


== JUnit Pioneer

Mission statement:

> JUnit Pioneer provides extensions for JUnit 5 and its Jupiter API.
> It does not limit itself to proven ideas with wide application but is purposely open to experiments.
> It aims to spin off successful and cohesive portions into sibling projects or back into the JUnit 5 code base.

=== JUnit Pioneer

We want to:

* provide helpful extensions
* be open to experimental ideas
* catch-all extensions that are too small +
  to be their own project

=== JUnit Pioneer

We are:

* Matthias BÃ¼nger -- Bishuemaster
* MihÃ¡ly VerhÃ¡s -- Chief Developer
* Nicolai Parlog -- Benevolent Dictator
* Simon Schottner -- Build Engineer

Plus about a dozen contribtors, +
some of them recurring.

=== JUnit Pioneer

We have:

* 4.7k lines of production code
* 5.9k lines of test code
* 26 releases, 5 since 1.0.0

// TODO: more meaningful stats?

=== How did we get here?

Sounds good? Not so fast!

* this is a hobby project
* life gets in the way
* for 3 years, little happened


[state="empty",background-color="#161b22"]
=== !
image::images/contributions.png[background, size=contain]

=== Experimentation

2016: ::
* JUnit 5 publishes first milestone builds
* Nicolai launches _JUnit Io_ for his +
  experiments with the extension API

> A melting pot for all kinds of extensions

Just a demo repo, no releases: +
â‡ 18 commits, 1.3k LOC, 300 LOX

// LOC 1348 / total 1647

=== Excitement

2017: ::
* JUnit 5 publishes release candidates +
  and in September 5.0.0
* https://github.com/smoyer64[Steve Moyer] plans to roll his own +
  experiments into a project
* Nicolai and Steve join forces and +
  rebrand _JUnit Io_ to _JUnit Pioneer_ +
  (first space craft to Jupiter)

Turning it into an actual project: +
â‡ 19 commits, -12 LOC ğŸ¤”, 430 LOX, 0 releases

// LOC 1336 / total 2077

=== ğŸ˜´

September 2017 to April 2018: ::

* Steve is busy teaching
* Nicolai always has more projects than time

â‡ 0 commits, 0 LOC/X, 0 releases

=== Takeoff

May to November 2018: ::

* JUnit 5 team helps Nicolai
* Pioneer lifts off the ground

â‡ 31 commits,
870 LOC, 450 LOX, +
4 contributors,
4 releases

// LOC 2202 / total 3396

=== ğŸ˜´ğŸ˜´

November 2018 to September 2019: ::
again, life gets in the way

â‡ 0 commits, 0 LOC/X, 0 releases

=== Cruise control

October 2019 to today: ::

* JUnit 5 team gives ultimatum
* magic happens ğŸ§™â€â™€ï¸ğŸ¦„âœ¨
* Pioneer flies at steady pace

â‡ ~150 commits,
8.4k LOC, 1.9k LOX, +
3 maintainers, 15 contributors, +
22 releases

// end of March 2021:
// LOC 10.6k / total 13.7k

=== Wait, Magic?

[state="empty",background-color="#3B3C3F"]
=== !
image::images/stream-coding.png[background, size=contain]

[state="empty",background-color="#3B3C3F"]
=== !
image::images/stream-troubles.png[background, size=contain]

[state="empty",background-color="black"]
=== !
image::images/stream-issues.png[background, size=contain]

[state="empty",background-color="black"]
=== !
image::images/stream-troubles-2.png[background, size=contain]

[state="empty",background-color="#252429"]
=== !
image::images/stream-helmet-2.png[background, size=contain]

[state="empty",background-color="#252429"]
=== !
image::images/stream-pioneer-glasses.png[background, size=contain]

[state="empty",background-color="#252429"]
=== !
image::images/stream-garland.png[background, size=contain]

=== Twitch

2019::
* Nicolai discovers Twitch
* does a few live streams in spring
* decides to stream regularly in December

2020::
* 30 JUnit Pioneer streams
* usually 3 to 5 hours

=== Twitch

Expected effects:

* commits Nicolai to ~10 h/month for Pioneer
* interests Java devs

=== Twitch

Unexpected effects:

* gives viewers insight into project
* viewers help in their areas of expertise
** in Twitch chat
** on GitHub
* viewers pick up small issues
* viewers become contributors
* contributors become maintainers

=== Twitch

Thanks to live-streaming this one-man show, +
became a real project:

* in April 2020, Simon and Matthias +
  became maintainers
* in November 2020, Mihaly joined

A few contributors also stop by the stream +
(and always enjoy when Nicolai reviews their PRs).


== Projecting

* communication & prioritization
* doing the dirty work
* fostering contributions
* managing expectations

=== Contributing Without Coding

Once a repo turns into a project, +
project management becomes essential.

There's plenty of ways of +
*contributing without coding*.

These contributions are often +
more important than code.

=== Contributing Without Coding

* curating issues
** creating, labeling, replying, closings
** prioritizing, organizing
* reviewing PRs
** technical merits
** completeness
* following up on uncomfortable tasks
* remembering/updating documentation

=== Dirty work

Coding is fun! Cleaning up (often) isn't.

As a maintainer:

* fix bugs first
* tackle the hard issues +
  (annotations, threading, merge conflicts)
* set up build pipeline, releases, +
  documentation, website, etc.

We created milestone _Cleaner Pioneers_ for that.

=== Preparing 1.0

Spring 2020 we started thinking about 1.0, +
but Pioneer has no cohesive feature set.

â‡ there's no good point for 1.0

Instead, prepare everything for users and contributors.

â‡ _Cleaner Pioneers_ became _1.0_

[state="empty",background-color="#0D1117"]
=== !
image::images/cleaner-pioneers.png[background, size=contain]

=== Since Then

* Pioneer still has no cohesive feature set
* all must-dos are done (for the time being)

â‡ Milestone is wrong concept.

So now we use a Kanban board +
(via GitHub's _Projects_ feature).

[state="empty",background-color="#0D1117"]
=== !
image::images/exploring-io.png[background, size=contain]

=== Pull Requests

Noteworthy details about PRs:

* checklist
* approval
* squash & merge

[state="empty",background-color="#0D1117"]
=== !
image::images/pr-checklist.png[background, size=contain]

=== Approving Pull Requests

Two maintainers need to approve a PR.

Lack of trust? +
No, sharing responsibility.

(More on that later.)

=== Squashing Commits

When a PR is ready to be merged:

* all commits are squashed into one
* commit message is carefully crafted
* that commit goes onto `main`

image::images/squash-merge.png[]

=== Squashing Commits

"But don't you loose the history?"

Yes!

* lets contributors use Git however they like
* keeps commit history clean
* leads to really good commit messages +
  (prepared as part of the PR)

[state="empty",background-color="#0D1117"]
=== !
image::images/commit-history.png[background, size=contain]

=== Fostering Contributions

[start=0]
. appreciation
. contribution guide
. explicit rules +
  (preferably simple)

=== Appreciation

We're appreciative:

* positive tone
* prioritize replies
* thank for contributions, +
  excuse delays
// * have a code of conduct
* list contributions

[state="empty",background-color="#0D1117"]
=== !
image::images/contributions-thanks.png[background, size=contain]

=== Contribution Guide

We have a (very long) `CONTRIBUTING.md`:

* describes all aspects in detail
* binds maintainers and contributors
* grew organically over time +
  (more in a few slides)

=== Contribution Guide

A partial table of contents:

* open source crash course (mosty links)
* code organization and style (more in next section)
* how to document: what goes where, style, etc.
* contribution workflow: branching, PRs, merging, etc.
* dependencies
* versioning
* communication

=== Simplicity

Some rules are intenionally strict +
to keep them simple and avoid discussions:

* always use AssertJ
* always use `Optional`
* always squash commits

_Consistency is king, simplicity is King Kong._

=== Communication Guide

Various channels by decreasing importance:

. project website
. files (e.g. `CONTRIBUTING.md`)
. Git commit messages
. issues/PRs on GitHub
. _#junit-pioneer_ in Discord
. team calls
. Twitch streams

=== Protecting Maintainers

> There's no expectation of availability!
> This applies to users opening issues, contributors providing PRs, and other maintainers - none of them can expect a maintainer to have time to reply to their request.

=== Sharing Responsibility

Struggle for newest maintainers:

* first open source project
* project pre-existed
* worried to break things

Solution:

* two maintainers sign off PRs
* Nicolai is the benevolent dictator

=== Benevolent Dictator

Nicolai has special...

* privilege -- can overrule anything
* duty -- should've prevented all mistakes

Writes Nicolai:

> I bare responsibility for all mistakes.
> (Moral responsibility, that is - legally, nobody has any responsibility. ğŸ˜‰)

=== Projecting

As you can see, quite a lof of +
project and team management.

Many ways to contribute without coding.


== Coding

* architecture
* dependency management
* how to test a test framework

=== Architecture

JUnit Pioneer has high-end architecture:

```sh
ğŸ“¦ org.junitpioneer
â”œâ”€ ğŸ“¦ internal  # our utilities - internal
â”œâ”€ ğŸ“¦ jupiter   # most of our extensions
â”‚Â  â”œâ”€ ğŸ“¦ issue  # issue impl - internal
â”‚Â  â””â”€ ğŸ“¦ params # ext. re parameterized tests
â””â”€ ğŸ“¦ vintage   # ext. re to JUnit 4
```

We mirror Jupiter's packages:

* `org.junit.jupiter.api`
* `org.junit.jupiter.params`

=== Internal packages

Speaking of internal packages:

* we created two (e.g. for annotations)
* we don't want people to use them

How?

* âš ï¸ one package is called `internal`
* âš ï¸ package info says it's internal
* ğŸ›‘ we ship modular JAR that +
  doesn't export these packages

=== More Architecture

To make navigation easier, +
we also have rules for:

* naming classes
* organizing top-level types +
  (e.g. repeatable annotations)
* how to use Jupiter's `Namespace`

No rocket science, but need to be upheld.

=== Dependency Management

Projects have enough problems +
with dependencies.

We don't want to add to that.

â‡ JUnit 5 should be our only +
runtime dependency.

=== In Practice

The `@Issue` extension:

* collects information about tests
* wants to create a report

But reports could be XML, JSON, etc.

* "need" dependencies for that
* probably not many users use `@Issue`

What now?

=== Resolution

Dependency inversion to the rescue +
(via Java's `ServiceLoader`):

* Pioneer declares interface `IssueProcessor`
* users implement it and register implementation
* Pioneer finds implementations and passes info

image::images/issue-service-loader.png[role="diagram"]

=== TestsÂ²

How do you test a test framework?

* want to verify error behavior
* want to test behavior outside of tests +
  (e.g. report entry publication)

We often write tests that run _other_ tests +
and then evaluate their results.

=== TestsÂ²

JUnit 5 has good support for that:

* we added a few usability methods
* we created our own assertions

```java
ExecutionResults results = executeTestMethod(
	MethodLevelInitializationFailureTestCase.class,
	"shouldFailMissingConfiguration");
assertThat(results)
	.hasSingleFailedTest()
	.withExceptionInstanceOf(/*...*/);
```

=== TestsÂ²

Thread safety:

* all our extensions should be thread-safe
* to test that, we run our tests in parallel
* that's not always fun

We're mostly sure, we got this. ğŸ˜¬


== Build Pipeline

* Gradle, Shipkit, Bintray, GitHub Actions
* Spotless, SonarQube, test coverage
* one-click release
* versioning
* website


== Challenges

* Bintray
* available time


include::../_shared/about-slide.adoc[]

include::images/sources.adoc[]
